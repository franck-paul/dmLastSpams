"use strict";dotclear.ready((()=>{dotclear.dmLastSpams=dotclear.getData("dm_lastspams");const e=(e,a="toggle",t=null)=>{if(null===e.getAttribute("id"))return;const s=e.getAttribute("id").substring(4),l=`dmlse${s}`;let o=document.getElementById(l);const r=!t.metaKey;o?(o.style.display="none"===o.style.display?"":"none",e.classList.toggle("expand")):dotclear.getCommentContent(s,(a=>{if(a)return o=document.createElement("li"),o.id=l,o.className="expand",o.insertAdjacentHTML("afterbegin",a),e.classList.add("expand"),void e.parentNode.insertBefore(o,e.nextSibling);e.classList.remove("expand")}),{metadata:!1,clean:r})},a=e=>{dotclear.services("dmLastSpamsCount",(a=>{try{const t=JSON.parse(a);if(!t?.success)return void console.log(dotclear.debug&&t?.message?t.message:"Dotclear REST server error");if(t?.payload.ret){const a=t.payload.nb;void 0!==a&&a!==dotclear.dmLastSpams.spamCount&&(dotclear.badge(e,{id:"dmls",value:a,remove:a<=0,sibling:!0,icon:!0}),dotclear.dmLastSpams.spamCount=a)}}catch(e){console.log(e)}}),(e=>{console.log(e)}),!0,{json:1})},t=()=>{dotclear.services("dmLastSpamsCheck",(a=>{try{const s=JSON.parse(a);if(!s?.success)return void console.log(dotclear.debug&&s?.message?s.message:"Dotclear REST server error");s?.payload.ret&&s.payload.nb>0&&(t=s.payload.last_id,dotclear.services("dmLastSpamsRows",(a=>{try{const t=JSON.parse(a);if(!t?.success)return void console.log(dotclear.debug&&t?.message?t.message:"Dotclear REST server error");if(t?.payload.ret){const{counter:a}=t.payload;for(const e of document.querySelectorAll("#last-spams ul"))e.remove();for(const e of document.querySelectorAll("#last-spams p"))e.remove();a>0&&(dotclear.dmLastSpams.lastCounter=Number(dotclear.dmLastSpams.lastCounter)+a);const s=document.querySelector("#last-spams h3");s?.insertAdjacentHTML("afterend",t.payload.list),dotclear.dmLastSpams.badge&&dotclear.badge(document.querySelector("#last-spams"),{id:"dmls",value:dotclear.dmLastSpams.lastCounter,remove:dotclear.dmLastSpams.lastcounter<=0}),dotclear.expandContent({lines:document.querySelectorAll("#last-spams li.line"),callback:e});for(const e of document.querySelectorAll("#last-spams ul"))e.classList.add("expandable")}}catch(e){console.log(e)}}),(e=>{console.log(e)}),!0,{json:1,stored_id:dotclear.dmLastSpams.lastSpamId,last_id:t,last_counter:dotclear.dmLastSpams.lastCounter}),dotclear.dmLastSpams.lastSpamId=s.payload.last_id)}catch(e){console.log(e)}var t}),(e=>{console.log(e)}),!0,{json:1,last_id:dotclear.dmLastSpams.lastSpamId})};dotclear.expandContent({lines:document.querySelectorAll("#last-spams li.line"),callback:e});for(const e of document.querySelectorAll("#last-spams ul"))e.classList.add("expandable");if(!dotclear.dmLastSpams.autoRefresh)return;if(t(),dotclear.dmLastSpams.timer=setInterval(t,1e3*(dotclear.dmLastSpams.interval||30)),!dotclear.dmLastSpams.badge)return;let s=document.querySelectorAll('#dashboard-main #icons p a[href="comments.php"]');s.length||(s=document.querySelectorAll("#dashboard-main #icons p #icon-process-comments-fav")),document.getElementById("last-spams")?.classList.add("badgeable"),s.length&&(a(s),dotclear.dmLastSpams.timerSpam=setInterval(a,1e3*(dotclear.dmLastSpams.interval||30),s))}));
